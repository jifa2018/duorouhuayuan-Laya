{
  "code": "import { ProtocolMap } from \"./Protocol\";\r\nimport { NetAnalysis } from \"./NetAnalysis\";\r\nimport { SocketState } from \"../GameDefine\";\r\nimport { Debug } from \"../../common/Debug\";\r\nimport { GEvent } from \"../../common/GEvent\";\r\nimport { GacEvent } from \"../../common/GacEvent\";\r\nexport const MAX_SEND_BUFFER_SIZE = 4094;\r\nexport const MESSAGE_HEAD_LENGTH = 2;\r\nexport class Network {\r\n    constructor() {\r\n        this._sequence = 0;\r\n        this._sendBuffer = new Laya.Byte();\r\n        this._recvBuffer = new Laya.Byte();\r\n        this._codeService = new NetAnalysis();\r\n        this._protocolMap = new ProtocolMap();\r\n    }\r\n    connect(host, port) {\r\n        if (this._socket) {\r\n            this.onConnectClose();\r\n        }\r\n        this._host = host;\r\n        this._port = port;\r\n        this._socket = new Laya.Socket();\r\n        this._socket.on(Laya.Event.OPEN, this, this.onConnected);\r\n        this._socket.on(Laya.Event.ERROR, this, this.onConnectFail);\r\n        this._socket.on(Laya.Event.CLOSE, this, this.onConnectClose);\r\n        this._socket.on(Laya.Event.MESSAGE, this, this.receive);\r\n        if (host.indexOf(\"ws://\") != -1 || host.indexOf(\"wss://\") != -1) {\r\n            this._socket.connectByUrl(host + \":\" + port);\r\n        }\r\n        else {\r\n            this._socket.connect(host, port);\r\n        }\r\n        this.setSocketState(SocketState.CONNECTING);\r\n    }\r\n    close() {\r\n        if (!this._socket) {\r\n            return;\r\n        }\r\n        try {\r\n            if (this._socket.connected == true) {\r\n                this._socket.cleanSocket();\r\n            }\r\n            this._socket.close();\r\n        }\r\n        catch (e) {\r\n            Debug.LogError(e);\r\n        }\r\n        finally {\r\n            this._sequence = 0;\r\n            this._socket = null;\r\n        }\r\n    }\r\n    send(msgType, ...args) {\r\n        if (!this._socket || !this.isConnected()) {\r\n            return;\r\n        }\r\n        let bt;\r\n        if (msgType.indexOf(\"G_\") == 0) {\r\n            bt = this._codeService.Encode(\"K_Ts\", msgType, ...args);\r\n        }\r\n        else {\r\n            bt = this._codeService.Encode(msgType, ...args);\r\n        }\r\n        bt.length = bt.pos;\r\n        if (bt.length > MAX_SEND_BUFFER_SIZE) {\r\n            Debug.LogError(\"消息长度超过\" + MAX_SEND_BUFFER_SIZE);\r\n            return;\r\n        }\r\n        this._sendBuffer.clear();\r\n        this._sendBuffer.writeUint16(bt.length + 1);\r\n        this._sendBuffer.writeUint8(this._sequence);\r\n        this._sendBuffer.writeArrayBuffer(bt.buffer);\r\n        if (++this._sequence >= 256) {\r\n            this._sequence = 0;\r\n        }\r\n        this._socket.send(this._sendBuffer.buffer);\r\n    }\r\n    receive(data) {\r\n        if (!this._socket || !this.isConnected()) {\r\n            return;\r\n        }\r\n        if (!(data instanceof ArrayBuffer)) {\r\n            Debug.LogError(\"接收网络消息类型错误! 消息类型应为ArrayBuffer！\");\r\n            return;\r\n        }\r\n        this._recvBuffer.writeArrayBuffer(data);\r\n        this._recvBuffer.pos = 0;\r\n        let packageDataLen = this._recvBuffer.getInt16();\r\n        if (packageDataLen <= 0) {\r\n            Debug.LogError(\"数据包长度小于等于零！\");\r\n            return;\r\n        }\r\n        if (packageDataLen + MESSAGE_HEAD_LENGTH > this._recvBuffer.length) {\r\n            this._recvBuffer.pos = this._recvBuffer.length;\r\n            return;\r\n        }\r\n        let _pos, _args;\r\n        while (true) {\r\n            _args = this._codeService.Decode(this._recvBuffer, packageDataLen);\r\n            let processInfo = this._protocolMap.GetProcessInfo(_args[0]);\r\n            if (processInfo != null) {\r\n                processInfo.protoBuf.GetData(_args);\r\n                processInfo.Dispatch();\r\n            }\r\n            if (this._recvBuffer.pos + MESSAGE_HEAD_LENGTH >= this._recvBuffer.length) {\r\n                break;\r\n            }\r\n            _pos = this._recvBuffer.pos;\r\n            packageDataLen = this._recvBuffer.getInt16();\r\n            if (packageDataLen > this._recvBuffer.length - this._recvBuffer.pos) {\r\n                this._recvBuffer.pos = _pos;\r\n                break;\r\n            }\r\n        }\r\n        this._socket.input.clear();\r\n        let buffer = this._recvBuffer.buffer.slice(this._recvBuffer.pos, this._recvBuffer.length);\r\n        this._recvBuffer.clear();\r\n        this._recvBuffer.writeArrayBuffer(buffer);\r\n    }\r\n    setSocketState(state) {\r\n        this._state = state;\r\n        if (this._state == SocketState.CONNECT_CLOSE) {\r\n            this.close();\r\n        }\r\n        if (this._state == SocketState.CONNECTING) {\r\n            Debug.Log(\"开始连接到服务器!\");\r\n            GEvent.DispatchEvent(GacEvent.OnConnecting);\r\n        }\r\n        else if (this._state == SocketState.CONNECTED) {\r\n            Debug.Log(\"连接服务器成功！\");\r\n            GEvent.DispatchEvent(GacEvent.OnConnected, true);\r\n        }\r\n        else if (this._state == SocketState.CONNECT_FAIL) {\r\n            Debug.Log(\"连接服务器失败！\");\r\n            GEvent.DispatchEvent(GacEvent.OnConnectFail);\r\n        }\r\n        else if (this._state == SocketState.CONNECT_CLOSE) {\r\n            Debug.Log(\"与服务器断开连接！\");\r\n            GEvent.DispatchEvent(GacEvent.OnConnectClose);\r\n        }\r\n    }\r\n    onConnected() {\r\n        this.setSocketState(SocketState.CONNECTED);\r\n    }\r\n    onConnectFail() {\r\n        this.setSocketState(SocketState.CONNECT_FAIL);\r\n    }\r\n    onConnectClose() {\r\n        this.setSocketState(SocketState.CONNECT_CLOSE);\r\n    }\r\n    isConnected() {\r\n        return this._state == SocketState.CONNECTED;\r\n    }\r\n    registerProtocol(protocolId, handler) {\r\n        this._protocolMap.AddProtocolHandler(protocolId, handler);\r\n    }\r\n    unRegisterProtocol(protocolId, handler) {\r\n        this._protocolMap.DelProtocolHandler(protocolId, handler);\r\n    }\r\n    TGW(arrayBuffer) {\r\n        this._socket.send(arrayBuffer);\r\n    }\r\n}\r\n//# sourceMappingURL=Network.js.map",
  "references": [
    "E:/project/duorou/client/src/game/net/Protocol.ts",
    "E:/project/duorou/client/src/game/net/NetAnalysis.ts",
    "E:/project/duorou/client/src/game/GameDefine.ts",
    "E:/project/duorou/client/src/common/Debug.ts",
    "E:/project/duorou/client/src/common/GEvent.ts",
    "E:/project/duorou/client/src/common/GacEvent.ts"
  ],
  "map": "{\"version\":3,\"file\":\"Network.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../src/game/net/Network.ts\"],\"names\":[],\"mappings\":\"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\"}"
}
